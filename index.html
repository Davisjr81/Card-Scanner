// Worker: /ebay (Browse API) + /vision (Google Vision OCR/labels)
const ALLOW_ORIGIN = 'https://davisjr81.github.io'; // your GitHub Pages origin

export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    if (request.method === 'OPTIONS') return cors204();

    try {
      if (url.pathname === '/' || url.pathname === '') {
        return json({ ok: true, routes: ['GET /ebay?q=', 'POST /vision {imageBase64}'] });
      }

      // ----- eBay search (Browse API) -----
      if (url.pathname === '/ebay' && request.method === 'GET') {
        if (!env.EBAY_USER_TOKEN) return json({ ok: false, error: 'Missing EBAY_USER_TOKEN' }, 500);
        const q = url.searchParams.get('q') || '';
        if (!q.trim()) return json({ ok: false, error: 'Missing q' }, 400);

        const ebayUrl = new URL('https://api.ebay.com/buy/browse/v1/item_summary/search');
        ebayUrl.searchParams.set('q', q);
        ebayUrl.searchParams.set('limit', '12');

        const r = await fetch(ebayUrl.toString(), {
          headers: {
            'Authorization': `Bearer ${env.EBAY_USER_TOKEN}`,
            'X-EBAY-C-MARKETPLACE-ID': 'EBAY_US',
            'Accept': 'application/json'
          }
        });
        const txt = await r.text();
        let data; try { data = JSON.parse(txt); } catch { return json({ ok:false, status:r.status, body:txt }, r.status); }
        return json({ ok: true, status: r.status, data });
      }

      // ----- Google Vision OCR / labels -----
      if (url.pathname === '/vision' && request.method === 'POST') {
        if (!env.GOOGLE_VISION_KEY) return json({ ok:false, error:'Missing GOOGLE_VISION_KEY' }, 500);
        let body = {};
        try { body = await request.json(); } catch {}
        const b64 = String(body.imageBase64 || '').split(',').pop(); // strip data URL
        if (!b64) return json({ ok:false, error:'No imageBase64' }, 400);

        const payload = {
          requests: [{
            image: { content: b64 },
            features: [
              { type: 'TEXT_DETECTION' },
              { type: 'LABEL_DETECTION', maxResults: 5 },
              { type: 'WEB_DETECTION',   maxResults: 5 }
            ]
          }]
        };

        const vres = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${env.GOOGLE_VISION_KEY}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        const vtxt = await vres.text();
        if (!vres.ok) return json({ ok:false, stage:'vision', status:vres.status, error:vtxt.slice(0,500) }, vres.status);

        const j = JSON.parse(vtxt);
        const r = j?.responses?.[0] || {};
        const ocr = r?.fullTextAnnotation?.text || '';
        const labels = (r?.labelAnnotations || []).map(x => x.description).filter(Boolean);
        const web = (r?.webDetection?.webEntities || []).map(x => x.description).filter(Boolean);

        return json({ ok:true, ocr, labels, web });
      }

      return json({ ok:false, error:'Not Found' }, 404);
    } catch (e) {
      return json({ ok:false, error:String(e) }, 500);
    }
  }
};

function corsHeaders() {
  return {
    'Access-Control-Allow-Origin': ALLOW_ORIGIN,
    'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization'
  };
}
function cors204(){ return new Response(null, { status:204, headers: corsHeaders() }); }
function json(obj, status=200){ return new Response(JSON.stringify(obj), { status, headers: { 'content-type':'application/json', ...corsHeaders() } }); }

  return headers;
}
