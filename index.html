<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Card Scanner</title>
    <style>
      body { font-family: system-ui, -apple-system, Arial, sans-serif; padding: 16px; }
      video { width: 100%; max-width: 480px; background: #000; border-radius: 8px; }
      button { padding: 10px 16px; font-size: 16px; margin-top: 12px; }
      pre { white-space: pre-wrap; background: #f6f6f6; padding: 12px; border-radius: 8px; }
    </style>
  </head>
  <body>
    <h1>Card Scanner (OCR)</h1>
    <video id="v" autoplay playsinline muted></video><br/>
    <button id="scanBtn">Scan text</button>
    <pre id="out"></pre>

    <script>
      const WORKER_URL = "https://<your-worker-subdomain>.workers.dev/ocr"; // <-- REPLACE THIS

      const v = document.getElementById('v');
      const out = document.getElementById('out');
      const btn = document.getElementById('scanBtn');

      async function startCam() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: false,
            video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } }
          });
          v.srcObject = stream;
          await v.play(); // ensure videoWidth/Height are set
        } catch (e) {
          out.textContent = "Camera error: " + e.message;
        }
      }

      function frameToBlob() {
        const c = document.createElement('canvas');
        const w = Math.min(1280, v.videoWidth || 1280);
        const h = Math.round(w * (v.videoHeight / (v.videoWidth || (1280/720))));
        c.width = w; c.height = h;
        const ctx = c.getContext('2d');
        ctx.drawImage(v, 0, 0, w, h);
        return new Promise(res => c.toBlob(b => res(b), 'image/jpeg', 0.9));
      }

      async function scan() {
        out.textContent = "Scanning...";
        try {
          const blob = await frameToBlob();
          const fd = new FormData();
          fd.append('file', blob, 'frame.jpg');

          const resp = await fetch(WORKER_URL, { method: 'POST', body: fd });
          const raw = await resp.text(); // show raw to debug if needed
          try {
            const json = JSON.parse(raw);
            if (!resp.ok) throw new Error(json.error || resp.statusText);
            const text = (json.ParsedResults && json.ParsedResults[0] && json.ParsedResults[0].ParsedText) || "";
            out.textContent = text ? text : "(No text found)";
          } catch (e) {
            out.textContent = "Parse error:\n" + e.message + "\nRaw:\n" + raw;
          }
        } catch (e) {
          out.textContent = "Scan error: " + e.message;
        }
      }

      btn.addEventListener('click', scan);
      startCam();
    </script>
  </body>
</html>
