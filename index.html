<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sports Card Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; color:#222; }
  header { background: #333; color: #fff; padding: 10px; text-align: center; }
  main { padding: 10px; max-width: 980px; margin: 0 auto; }
  video { width: 100%; max-height: 240px; background: #000; }
  #status { margin-top: 6px; font-size: 14px; }
  #ocr { background: #fff; padding: 8px; margin-top: 6px; min-height: 40px; font-size: 14px; border: 1px solid #ccc; white-space: pre-wrap; }
  #controls { margin-top: 10px; display: grid; grid-template-columns: 1fr auto auto auto auto auto; gap: 6px; align-items: center; }
  #controls input[type="text"] { padding: 6px; }
  #controls button { padding: 6px 10px; }
  #controls label { font-size: 13px; }
  iframe { width: 100%; height: 420px; border: 1px solid #ddd; border-radius: 4px; background:#fff; margin-top: 10px; }
  @media (max-width: 700px){
    #controls { grid-template-columns: 1fr 1fr 1fr; }
  }
</style>
</head>
<body>

<header>
  <h1>Sports Card Scanner</h1>
</header>

<main>
  <video id="v" autoplay playsinline muted></video>
  <div id="status">Initializing camera...</div>
  <div id="ocr">(No scan results yet)</div>

  <div id="controls">
    <input type="text" id="query" placeholder="Search query" />
    <button id="searchBtn" type="button">Search</button>
    <button id="toggle" type="button">Pause</button>
    <button id="startBtn" type="button">Start Camera</button>
    <label><input type="checkbox" id="soldOnly" /> Sold Only</label>
    <label><input type="checkbox" id="newly" /> Newly Listed</label>
    <label>Interval (ms): <input type="number" id="interval" value="2000" min="500" step="100" /></label>
  </div>

  <iframe id="ebay" src=""></iframe>
</main>

<script>
/*** CONFIG: Point these to your Worker ***/
const PROXY_OCR = "https://rough-glitter-4d48.jamie-davis81.workers.dev/ocrspace";
const PROXY_VISION = "https://rough-glitter-4d48.jamie-davis81.workers.dev/vision";

/*** Elements ***/
const v = document.getElementById("v");
const statusEl = document.getElementById("status");
const ocrEl = document.getElementById("ocr");
const ebayFrame = document.getElementById("ebay");
const inputQuery = document.getElementById("query");
const btnToggle = document.getElementById("toggle");
const btnSearch = document.getElementById("searchBtn");
const soldOnly = document.getElementById("soldOnly");
const newly = document.getElementById("newly");
const intervalInput = document.getElementById("interval");
const startBtn = document.getElementById("startBtn");

/*** State ***/
let stream = null;
let timer = null;
let running = false;
let lastQuery = "";
let lastCombined = "";
let lastSearchAt = 0;
let stableCount = 0;
const REQUIRED_STABLE = 2;
const MIN_DELAY = 10000; // ms between searches

/*** Camera ***/
async function startCamera(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    v.srcObject = stream;
    await v.play().catch(()=>{});
    statusEl.textContent = "Camera running. Sequential OCR â†’ Vision scan mode.";
    startBtn.style.display = "none";
    startLoop();
  } catch (err) {
    statusEl.textContent = "Camera blocked. Allow access and retry.";
  }
}

function grabFrameBase64(){
  if (!stream) return null;
  const track = stream.getVideoTracks()[0];
  if (!track) return null;
  const s = track.getSettings ? track.getSettings() : {};
  const c = document.createElement("canvas");
  c.width = s.width || v.videoWidth || 1280;
  c.height = s.height || v.videoHeight || 720;
  const ctx = c.getContext("2d");
  ctx.translate(c.width, 0);
  ctx.scale(-1, 1);
  ctx.drawImage(v, 0, 0, c.width, c.height);
  return c.toDataURL("image/jpeg", 0.85);
}

/*** Sequential scan: OCR then Vision ***/
async function scanOnce(){
  try {
    const base64 = grabFrameBase64();
    if (!base64) return;

    // Step 1: OCR
    statusEl.textContent = "Running OCR...";
    const ocrRes = await fetch(PROXY_OCR, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ imageBase64: base64 })
    });
    const ocrData = await ocrRes.json();
    const ocrText = ocrData.text || "";

    // Step 2: Vision
    statusEl.textContent = "Running Vision...";
    const visionRes = await fetch(PROXY_VISION, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ imageBase64: base64 })
    });
    const visionData = await visionRes.json();
    const visionParts = [];
    if (visionData.ocr) visionParts.push(visionData.ocr);
    if (Array.isArray(visionData.entities)) visionParts.push(visionData.entities.slice(0,3).join(" "));
    if (Array.isArray(visionData.guesses) && visionData.guesses.length) visionParts.push(visionData.guesses[0]);
    const visionText = visionParts.join(" ").trim();

    // Step 3: Combine results
    const combined = (ocrText + " " + visionText).replace(/\s+/g, " ").trim();
    ocrEl.textContent = combined || "(no text yet)";

    // Step 4: Stability + search
    if (combined === lastCombined){
      stableCount++;
    } else {
      stableCount = 1;
      lastCombined = combined;
    }
    if (stableCount >= REQUIRED_STABLE){
      const q = buildQuery(combined);
      inputQuery.value = q;
      maybeSearch(q);
      stableCount = 0;
    }

  } catch (e) {
    statusEl.textContent = "Scan error. Retrying...";
  }
}

/*** Build query ***/
function buildQuery(raw){
  var q = raw || "";
  q = q.replace(/[\r\n]+/g, " ").replace(/[^\w\s#-]/g, " ").trim();
  return q.split(/\s+/).slice(0, 10).join(" ");
}

/*** eBay search ***/
function ebayURL(query){
  var base = "https://www.ebay.com/sch/i.html?_nkw=";
  var kw = encodeURIComponent(query);
  var params = [];
  if (soldOnly.checked) { params.push("LH_Sold=1", "LH_Complete=1"); }
  if (newly.checked) { params.push("LH_Time=1"); }
  return base + kw + (params.length ? "&" + params.join("&") : "");
}

function maybeSearch(q){
  var now = Date.now();
  if (!q || q.length < 4) return;
  if (q === lastQuery && (now - lastSearchAt) < MIN_DELAY) return;

  lastQuery = q;
  lastSearchAt = now;
  ebayFrame.src = ebayURL(q);
  statusEl.textContent = "Searching eBay for: " + q;
}

/*** Loop control ***/
function startLoop(){
  stopLoop();
  running = true;
  btnToggle.textContent = "Pause";
  var ms = Math.max(600, parseInt(intervalInput.value || "2000", 10));
  timer = setInterval(scanOnce, ms);
}
function stopLoop(){
  running = false;
  btnToggle.textContent = "Resume";
  if (timer) clearInterval(timer);
}

/*** UI events ***/
btnToggle.addEventListener("click", function(){
  if (running) stopLoop(); else startLoop();
});
btnSearch.addEventListener("click", function(){
  var q = inputQuery.value || "";
  if (q) maybeSearch(q);
});
soldOnly.addEventListener("change", function(){
  if (lastQuery) maybeSearch(lastQuery);
});
newly.addEventListener("change", function(){
  if (lastQuery) maybeSearch(lastQuery);
});
intervalInput.addEventListener("change", function(){
  if (running) startLoop();
});
startBtn.addEventListener("click", startCamera);

// Auto-start camera if already granted
document.addEventListener("DOMContentLoaded", function(){
  if (navigator.permissions && navigator.permissions.query){
    navigator.permissions.query({ name: "camera" }).then(function(perm){
      if (perm.state === "granted") startCamera();
    }).catch(function(){});
  }
});
</script>

</body>
</html>
