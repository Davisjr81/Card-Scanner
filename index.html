<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sports Card Scanner</title>
  <style>
    :root { --pad:14px; }
    body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:var(--pad);max-width:980px;margin:0 auto;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0;}
    video{width:100%;max-height:52vh;border:1px solid #ccc;border-radius:8px;background:#111;object-fit:cover}
    textarea,input{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:15px}
    iframe{width:100%;height:52vh;border:1px solid #ccc;border-radius:8px;background:#fafafa}
    button{padding:8px 12px;border:1px solid #2b6cb0;background:#2b6cb0;color:#fff;border-radius:8px;cursor:pointer}
    button.secondary{background:#fff;color:#2b6cb0}
    .pill{font:12px/1.6 system-ui;border:1px solid #ddd;border-radius:999px;padding:4px 10px;display:inline-block}
    .muted{opacity:.7}
    .right{margin-left:auto}
  </style>
</head>
<body>

  <h2>Sports Card Scanner</h2>

  <video id="v" autoplay playsinline muted></video>

  <div class="row">
    <button id="btnToggle">Pause</button>
    <label class="pill">Interval (ms): <input id="interval" type="number" min="600" step="100" value="2400" style="width:90px;margin-left:6px"></label>
    <label class="pill"><input id="autoStop" type="checkbox" checked> Auto‑stop after first match</label>
    <button id="btnOnce" class="secondary right">Scan Once</button>
  </div>

  <div id="status" class="muted">Starting camera…</div>

  <h3>OCR Text</h3>
  <textarea id="ocr" rows="5" readonly>(no text yet)</textarea>

  <h3>Search Query</h3>
  <input id="query" placeholder="Built automatically from OCR…" />
  <div class="row">
    <button id="btnSearch" class="secondary">Search</button>
    <button id="btnResume" class="secondary right" style="display:none">Resume scanning</button>
  </div>

  <h3>eBay Results</h3>
  <iframe id="ebay" title="eBay results"></iframe>

<script>
/*** CONFIG ***/
const WORKER = 'https://YOUR_WORKER_URL'; // e.g. https://rough-glitter-4d48.jamie-davis81.workers.dev

/*** Elements ***/
const v = document.getElementById('v');
const statusEl = document.getElementById('status');
const ocrEl = document.getElementById('ocr');
const queryEl = document.getElementById('query');
const ebayFrame = document.getElementById('ebay');
const btnToggle = document.getElementById('btnToggle');
const btnOnce = document.getElementById('btnOnce');
const btnSearch = document.getElementById('btnSearch');
const btnResume = document.getElementById('btnResume');
const intervalEl = document.getElementById('interval');
const autoStopEl = document.getElementById('autoStop');

/*** State ***/
let stream, timer=null, running=true, lastQuery='', lastVisionText='';

/*** Camera ***/
async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} }, audio:false
    });
    v.srcObject = stream;
    await v.play().catch(()=>{});
    statusEl.textContent = 'Camera running — scanning automatically.';
    startLoop();
  }catch(e){
    statusEl.textContent = 'Camera blocked. Tap "Scan Once" after allowing camera.';
    console.error(e);
  }
}

function stopLoop(){
  running = false;
  clearInterval(timer); timer = null;
  btnToggle.textContent = 'Resume';
  btnResume.style.display = 'inline-block';
}
function startLoop(){
  running = true;
  clearInterval(timer);
  const ms = Math.max(600, parseInt(intervalEl.value||'2400',10));
  timer = setInterval(scanOnce, ms);
  btnToggle.textContent = 'Pause';
  btnResume.style.display = 'none';
}

/*** Image capture (center crop, un-mirror, slight enhance) ***/
function grabCroppedFrame(){
  if (!stream) return null;
  const track = stream.getVideoTracks()[0]; if (!track) return null;
  const s = track.getSettings(); const W = s.width || 1280, H = s.height || 720;

  // Wider crop: 88% width, 68% height — tweak to taste
  const cw = Math.floor(W * 0.88), ch = Math.floor(H * 0.68);
  const sx = Math.floor((W - cw)/2), sy = Math.floor((H - ch)/2);

  const c = document.createElement('canvas'); c.width = cw; c.height = ch;
  const ctx = c.getContext('2d');
  ctx.translate(cw,0); ctx.scale(-1,1);                // un-mirror selfie view
  ctx.filter = 'contrast(1.25) brightness(1.06)';      // mild boost helps OCR
  ctx.drawImage(v, sx, sy, cw, ch, 0, 0, cw, ch);
  return c.toDataURL('image/jpeg', 0.92);
}

/*** Vision call via Worker ***/
async function visionOCR(base64){
  const resp = await fetch(`${WORKER}/vision`, {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({ imageBase64: base64 })
  });
  if (!resp.ok) throw new Error('Vision error '+resp.status);
  return await resp.json(); // expected {ocr, labels, webEntities}
}

/*** Query builder — cleans & prioritizes key tokens ***/
function buildQuery(text, labels=[]){
  if (!text) return '';
  let q = text.toLowerCase()
    .replace(/[^\w\s\-\/]/g,' ')
    .replace(/\s+/g,' ')
    .trim();

  // Promote likely card tokens
  const BRANDS = ['topps','panini','prizm','select','optic','mosaic','donruss','bowman','chrome','heritage','finest','stadium','upper deck','fleer','score'];
  const SPORTS = ['rc','rookie','baseball','basketball','football','mlb','nba','nfl'];
  const YEARS  = /\b(19|20)\d{2}\b/g;

  const foundYear = (q.match(YEARS)||[]).slice(0,1);
  const brand = BRANDS.find(b=>q.includes(b)) || (labels||[]).map(s=>s.toLowerCase()).find(s=>BRANDS.some(b=>s.includes(b)));
  // crude player guess: two capitalized words from original (before lowercasing)
  const nameGuess = (lastVisionText || '')
    .replace(/[^\w\s\-']/g,' ')
    .split(/\s+/)
    .filter(w=>/^[A-Z][a-z]+$/.test(w))
    .slice(0,6);
  let player='';
  for (let i=0;i+1<nameGuess.length;i++){
    if (nameGuess[i].length>1 && nameGuess[i+1].length>1){
      player = `${nameGuess[i]} ${nameGuess[i+1]}`; break;
    }
  }

  const parts = [];
  if (foundYear[0]) parts.push(foundYear[0]);
  if (brand) parts.push(brand);
  if (player) parts.push(player);
  if (!parts.length){
    // fallback: keep some nouns from text
    const keep = q.split(' ').filter(w => w.length>2 && !SPORTS.includes(w)).slice(0,6);
    parts.push(...keep);
  }

  return parts.join(' ').trim();
}

/*** eBay URL (no-key public search) ***/
function ebayURL(query){
  const kw = encodeURIComponent(query);
  return `https://www.ebay.com/sch/i.html?_nkw=${kw}`;
}

/*** Main scan ***/
let busy = false;
async function scanOnce(){
  if (busy) return;
  busy = true;
  try{
    const base64 = grabCroppedFrame();
    if (!base64){ busy=false; return; }

    statusEl.textContent = 'Analyzing…';
    const r = await visionOCR(base64);
    const text = (r && r.ocr) || '';
    lastVisionText = text;
    ocrEl.value = text || '(no text yet)';

    const labels = (r && r.labels) || [];
    const q = buildQuery(text, labels);
    queryEl.value = q;

    if (q && q !== lastQuery){
      lastQuery = q;
      ebayFrame.src = ebayURL(q);
      statusEl.textContent = `Searching eBay for “${q}”…`;

      if (autoStopEl.checked){
        stopLoop();
        statusEl.textContent = `Stopped after sending “${q}”. Tap “Resume scanning” when ready.`;
      }
    } else {
      statusEl.textContent = 'Scanning…';
    }
  }catch(e){
    console.error(e);
    statusEl.textContent = 'Scan error — will retry';
  }finally{
    busy = false;
  }
}

/*** UI events ***/
btnToggle.addEventListener('click', ()=>{
  if (running) stopLoop(); else startLoop();
});
btnOnce.addEventListener('click', scanOnce);
btnResume.addEventListener('click', startLoop);
btnSearch.addEventListener('click', ()=>{
  const q = (queryEl.value||'').trim();
  if (!q) return;
  ebayFrame.src = ebayURL(q);
  if (autoStopEl.checked) stopLoop();
});

/*** Start ***/
startCamera();
</script>
</body>
</html>
