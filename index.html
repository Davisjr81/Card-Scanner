<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sports Card Scanner</title>
  <style>
    :root { --pad: 14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; padding:var(--pad); background:#fafafa; }
    #wrap { max-width: 960px; margin: 0 auto; }
    video { width: 100%; max-height: 48vh; background:#000; border:1px solid #ddd; border-radius:8px; display:block; }
    .row { display:flex; gap:10px; align-items:center; margin:10px 0; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    #status { font-size: 14px; color:#666; }
    #ocr, #query { width:100%; min-height:48px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:10px; padding:10px; }
    .price { font-weight:600; }
    #startBtn { position:relative; z-index:2; }
  </style>
</head>
<body>
<div id="wrap">
  <h2>Sports Card Scanner</h2>

  <video id="v" playsinline muted></video>

  <div class="row">
    <button id="startBtn">Start Camera</button>
    <button id="toggleBtn">Pause</button>
    <label>Interval(ms): <input id="interval" type="number" value="1500" min="400" step="100"></label>
  </div>

  <div id="status">Idle.</div>

  <h4>OCR Text</h4>
  <div id="ocr">(no text yet)</div>

  <h4>Search Query</h4>
  <div id="query">(none)</div>

  <h4>eBay Results</h4>
  <div id="results" class="grid"></div>
</div>

<script>
const WORKER_BASE = "https://rough-glitter-4d48.jamie-davis81.workers.dev";

const v = document.getElementById('v');
const startBtn = document.getElementById('startBtn');
const toggleBtn = document.getElementById('toggleBtn');
const intervalInput = document.getElementById('interval');
const statusEl = document.getElementById('status');
const ocrEl = document.getElementById('ocr');
const queryEl = document.getElementById('query');
const resultsEl = document.getElementById('results');

let stream = null, timer = null, running = false;

startBtn.addEventListener('click', async () => {
  await startCamera();
});
toggleBtn.addEventListener('click', () => {
  if (running) stopLoop(); else startLoop();
});
intervalInput.addEventListener('change', () => { if (running) startLoop(); });

async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" }, width:{ideal:1280}, height:{ideal:720} },
      audio: false
    });
    v.srcObject = stream;
    await v.play().catch(()=>{});
    statusEl.textContent = "Camera running — scanning automatically…";
    startBtn.style.display = 'none';
    startLoop();
  }catch(e){
    console.error(e);
    statusEl.textContent = "Camera blocked. Tap Start, allow camera, then retry.";
  }
}

function stopLoop(){
  running = false;
  toggleBtn.textContent = "Resume";
  if (timer) clearInterval(timer);
  timer = null;
}
function startLoop(){
  stopLoop();
  running = true;
  toggleBtn.textContent = "Pause";
  const ms = Math.max(600, parseInt(intervalInput.value || "1500", 10));
  timer = setInterval(scanOnce, ms);
  // fire one immediately
  scanOnce();
}

function grabFrameBase64(){
  if (!v || v.readyState < 2) return null;
  const w = v.videoWidth || 1280, h = v.videoHeight || 720;
  // downscale & compress for faster OCR/AI
  const targetW = Math.min(1024, w);
  const targetH = Math.round(h * (targetW / w));
  const c = document.createElement('canvas');
  c.width = targetW; c.height = targetH;
  const ctx = c.getContext('2d');
  // If preview is mirrored, draw normal for OCR/AI:
  ctx.drawImage(v, 0, 0, targetW, targetH);
  return c.toDataURL('image/jpeg', 0.85);
}

async function scanOnce(){
  try{
    const base64 = grabFrameBase64();
    if (!base64) return;

    statusEl.textContent = "Scanning…";
    const res = await fetch(WORKER_BASE + "/scan", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ imageBase64: base64 })
    });

    const data = await res.json().catch(()=>({ok:false, error:"Bad JSON"}));

    if (!res.ok || !data.ok) {
      console.warn("Scan error", data);
      statusEl.textContent = `Scan error (${data?.stage || res.status}): ${data?.error || res.statusText}. Retrying…`;
      return;
    }

    // Show OCR text + query
    ocrEl.textContent = (data.ocrText || "").trim() || "(no text)";
    queryEl.textContent = data.query || "(no query)";
    statusEl.textContent = "OK";

    // Render a few eBay results
    renderEbay(data.ebay);
  }catch(e){
    console.error(e);
    statusEl.textContent = "Scan error. Retrying…";
  }
}

function renderEbay(payload){
  resultsEl.innerHTML = "";
  try{
    const items = payload?.findItemsByKeywordsResponse?.[0]?.searchResult?.[0]?.item || [];
    items.slice(0, 8).forEach(it => {
      const title = it.title?.[0] || "Untitled";
      const price = it.sellingStatus?.[0]?.currentPrice?.[0]?.__value__ || "";
      const url = it.viewItemURL?.[0] || "#";
      const img = it.galleryURL?.[0] || "";

      const div = document.createElement('div');
      div.className = "card";
      div.innerHTML = `
        <div><a href="${url}" target="_blank">${title}</a></div>
        ${img ? `<img src="${img}" alt="" style="max-width:100%;border-radius:6px;margin:6px 0;">` : ""}
        <div class="price">${price ? "$" + price : ""}</div>
      `;
      resultsEl.appendChild(div);
    });
    if (!items.length) {
      resultsEl.innerHTML = "<div>(no matching items)</div>";
    }
  }catch(e){
    console.warn("Render eBay failed", e);
    resultsEl.innerHTML = "<div>Could not parse eBay response.</div>";
  }
}
</script>
</body>
</html>
