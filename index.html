<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sports Card Scanner (Local OCR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tesseract.js (runs OCR locally; no key needed) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    :root { --pad: 14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; padding:var(--pad); background:#f7f7f7; color:#222; }
    #wrap { max-width: 980px; margin: 0 auto; }
    h2 { margin: 6px 0 10px; }
    video { width: 100%; max-height: 48vh; background:#000; border:1px solid #ddd; border-radius:8px; display:block; }
    .row { display:flex; gap:10px; align-items:center; margin:10px 0; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    input[type="number"] { padding:8px; width:100px; }
    #status { font-size: 14px; color:#555; margin: 6px 0; }
    #ocrText, #queryBox { width:100%; min-height:48px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; white-space:pre-wrap; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; margin-top:8px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:10px; padding:10px; }
    .price { font-weight:600; margin-top:6px; }
    .note { font-size:12px; color:#666; }
  </style>
</head>
<body>
<div id="wrap">
  <h2>Sports Card Scanner (Local OCR)</h2>

  <video id="v" playsinline muted></video>

  <div class="row">
    <button id="startBtn" type="button">Start Camera</button>
    <button id="toggleBtn" type="button">Pause</button>
    <label>Interval (ms):
      <input id="interval" type="number" value="1800" min="600" step="100">
    </label>
    <button id="scanOnceBtn" type="button">Scan Once</button>
  </div>

  <div id="status">Idle.</div>

  <h4>OCR Text</h4>
  <div id="ocrText">(none)</div>

  <h4>Search Query</h4>
  <div id="queryBox">(none)</div>

  <h4>eBay Results</h4>
  <div id="results" class="grid"></div>
  <div class="note">Tip: fill the frame with the card, avoid glare, and keep it steady for 2–3 scans.</div>
</div>

<script>
const WORKER_BASE = "https://rough-glitter-4d48.jamie-davis81.workers.dev";

const v = document.getElementById('v');
const startBtn = document.getElementById('startBtn');
const toggleBtn = document.getElementById('toggleBtn');
const intervalInput = document.getElementById('interval');
const scanOnceBtn = document.getElementById('scanOnceBtn');
const statusEl = document.getElementById('status');
const ocrEl = document.getElementById('ocrText');
const queryEl = document.getElementById('queryBox');
const resultsEl = document.getElementById('results');

let stream = null, timer = null, running = false;
let lastQuery = "", lastOCR = "", stableCount = 0, lastSearchAt = 0;
const REQUIRED_STABLE = 2;   // same OCR twice in a row
const MIN_DELAY = 8000;      // min ms between searches

startBtn.addEventListener('click', startCamera);
toggleBtn.addEventListener('click', () => running ? stopLoop() : startLoop());
intervalInput.addEventListener('change', () => { if (running) startLoop(); });
scanOnceBtn.addEventListener('click', scanOnce);

async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" }, width:{ideal:1280}, height:{ideal:720} },
      audio: false
    });
    v.srcObject = stream;
    await v.play().catch(()=>{});
    startBtn.style.display = 'none';
    statusEl.textContent = "Camera running. Auto scan is active.";
    startLoop();
  }catch(e){
    console.error(e);
    statusEl.textContent = "Camera blocked. Click Start and allow camera access.";
  }
}
function stopLoop(){
  running = false;
  toggleBtn.textContent = "Resume";
  if (timer) clearInterval(timer);
  timer = null;
}
function startLoop(){
  stopLoop();
  running = true;
  toggleBtn.textContent = "Pause";
  const ms = Math.max(600, parseInt(intervalInput.value || "1800", 10));
  timer = setInterval(scanOnce, ms);
  scanOnce();
}

function grabFrameBase64(){
  if (!v || v.readyState < 2) return null;
  const w = v.videoWidth || 1280, h = v.videoHeight || 720;
  const targetW = Math.min(1024, w);
  const targetH = Math.round(h * (targetW / w));
  const c = document.createElement('canvas');
  c.width = targetW; c.height = targetH;
  const ctx = c.getContext('2d');
  ctx.drawImage(v, 0, 0, targetW, targetH);
  return c.toDataURL('image/jpeg', 0.85);
}

async function localOCR(base64){
  const blob = await (await fetch(base64)).blob();
  const { data: { text } } = await Tesseract.recognize(blob, 'eng', { logger: m => console.log(m) });
  return (text || "").replace(/\s+/g, " ").trim();
}

function buildQueryFromText(t){
  // keep it short & stable
  return (t || "")
    .replace(/[^\w\s#-]/g, " ")
    .replace(/\s+/g, " ")
    .trim()
    .split(/\s+/)
    .slice(0, 12)
    .join(" ");
}

async function scanOnce(){
  try{
    const base64 = grabFrameBase64();
    if (!base64) return;

    statusEl.textContent = "Running local OCR…";
    const text = await localOCR(base64);
    ocrEl.textContent = text || "(none)";

    if (!text || text.length < 4){
      stableCount = 0;
      statusEl.textContent = "No readable text yet. Adjust lighting or move closer.";
      return;
    }

    // Stability check
    if (text === lastOCR) stableCount++; else { stableCount = 1; lastOCR = text; }

    if (stableCount >= REQUIRED_STABLE){
      const query = buildQueryFromText(text);
      queryEl.textContent = query || "(none)";

      const now = Date.now();
      if (query && (now - lastSearchAt) > MIN_DELAY && query !== lastQuery){
        statusEl.textContent = "Searching eBay…";
        const ebay = await fetch(WORKER_BASE + "/ebay", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ query })
        });
        const data = await ebay.json().catch(()=>({ok:false}));
        if (!ebay.ok || !data.ok){
          statusEl.textContent = `eBay error: ${data?.error || ebay.statusText}`;
        } else {
          renderEbay(data);
          lastSearchAt = now;
          lastQuery = query;
          statusEl.textContent = "OK";
        }
        stableCount = 0;
      }
    } else {
      statusEl.textContent = `Stabilizing (${stableCount}/${REQUIRED_STABLE})…`;
    }

  }catch(e){
    console.error(e);
    statusEl.textContent = "Scan error. Retrying…";
  }
}

function renderEbay(payload){
  resultsEl.innerHTML = "";
  try{
    const items = payload?.findItemsByKeywordsResponse?.[0]?.searchResult?.[0]?.item || [];
    items.slice(0, 12).forEach(it => {
      const title = it.title?.[0] || "Untitled";
      const price = it.sellingStatus?.[0]?.currentPrice?.[0]?.__value__ || "";
      const url = it.viewItemURL?.[0] || "#";
      const img = it.galleryURL?.[0] || "";
      const div = document.createElement('div');
      div.className = "card";
      div.innerHTML = `
        <div><a href="${url}" target="_blank" rel="noopener">${title}</a></div>
        ${img ? `<img src="${img}" alt="" style="max-width:100%;border-radius:6px;margin:6px 0;">` : ""}
        <div class="price">${price ? "$" + price : ""}</div>
      `;
      resultsEl.appendChild(div);
    });
    if (!items.length) resultsEl.innerHTML = "<div>(no matching items)</div>";
  }catch(e){
    resultsEl.innerHTML = "<div>Could not parse eBay response.</div>";
  }
}

// Auto-start camera if already granted
document.addEventListener("DOMContentLoaded", function(){
  if (navigator.permissions && navigator.permissions.query){
    navigator.permissions.query({ name: "camera" })
      .then(p => { if (p.state === "granted") startCamera(); })
      .catch(()=>{});
  }
});
</script>
</body>
</html>
