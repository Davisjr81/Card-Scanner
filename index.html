<script>
/*** 1) CONFIG ***/
// Proxy endpoints for your Cloudflare Worker
const PROXY_OCR = 'https://rough-glitter-4d48.jamie-davis81.workers.dev/ocrspace';
const PROXY_VISION = 'https://rough-glitter-4d48.jamie-davis81.workers.dev/vision';

/*** 2) Elements ***/
const v = document.getElementById('v');
const statusEl = document.getElementById('status');
const ocrEl = document.getElementById('ocr');
const ebayFrame = document.getElementById('ebay');
const inputQuery = document.getElementById('query');
const btnToggle = document.getElementById('toggle');
const btnSearch = document.getElementById('searchBtn');
const soldOnly = document.getElementById('soldOnly');
const newly = document.getElementById('newly');
const intervalInput = document.getElementById('interval');
const startBtn = document.getElementById('startBtn');

/*** 3) State ***/
let stream, timer=null, running=false, lastQuery='', lastOCR='', lastSearchAt=0;

/*** 4) Camera ***/
async function startCamera(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }, audio:false });
    v.srcObject = stream;
    await v.play().catch(()=>0);
    statusEl.textContent = 'Camera running — scanning automatically.';
    startBtn.style.display = 'none';
    startLoop();
  } catch(err) {
    statusEl.textContent = 'Camera blocked. Tap Start, allow camera, then try again.';
    console.error(err);
  }
}

function grabFrameBase64(){
  if (!stream) return null;
  const track = stream.getVideoTracks()[0];
  if (!track) return null;
  const s = track.getSettings();
  const c = document.createElement('canvas');
  c.width = s.width || 1280;
  c.height = s.height || 720;
  const ctx = c.getContext('2d');
  ctx.translate(c.width, 0);
  ctx.scale(-1, 1);
  ctx.drawImage(v, 0, 0);
  return c.toDataURL('image/jpeg', 0.85);
}

/*** 5) OCR.Space via Worker ***/
async function ocrOnce(){
  try{
    const base64 = grabFrameBase64();
    if (!base64) return;
    const res = await fetch(PROXY_OCR, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ imageBase64: base64 })
    });
    if (!res.ok) throw new Error('HTTP '+res.status);
    const { text = '' } = await res.json();
    ocrEl.textContent = text || '(no text yet)';
    if (text && text !== lastOCR) {
      lastOCR = text;
      const q = buildQuery(text);
      inputQuery.value = q;
      maybeSearch(q);
    }
  }catch(e){
    console.log('OCR error', e);
    statusEl.textContent = 'OCR error — will retry.';
  }
}

/*** 6) Google Vision via Worker (optional) ***/
async function aiOnce(){
  try{
    const base64 = grabFrameBase64();
    if (!base64) return;
    const res = await fetch(PROXY_VISION, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ imageBase64: base64 })
    });
    if (!res.ok) return;
    const { ocr='', entities=[], guesses=[] } = await res.json();
    const parts = [ocr, entities.slice(0,3).join(' '), guesses[0] || ''].filter(Boolean);
    const q = parts.join(' ').replace(/\s+/g,' ').trim();
    if (q && q !== inputQuery.value){
      inputQuery.value = q;
      maybeSearch(q);
    }
  }catch(e){ console.log('Vision error', e); }
}

/*** 7) Build a search query ***/
function buildQuery(raw){
  let q = raw || '';
  q = q.replace(/[\r\n]+/g,' ').replace(/[^\w\s#-]/g,' ').trim();
  const tok = q.split(/\s+/).slice(0,10).join(' ');
  return tok;
}

/*** 8) eBay search ***/
function ebayURL(query){
  const base = 'https://www.ebay.com/sch/i.html?_nkw=';
  const kw = encodeURIComponent(query);
  const p = [];
  if (soldOnly.checked) p.push('LH_Sold=1','LH_Complete=1');
  if (newly.checked) p.push('LH_Time=1');
  return base + kw + (p.length ? '&' + p.join('&') : '');
}

function maybeSearch(q){
  if (!q || q.length < 4) return;
  const now = Date.now();
  if (q !== lastQuery && (now - lastSearchAt) > 5000){
    lastQuery = q; lastSearchAt = now;
    ebayFrame.src = ebayURL(q);
    statusEl.textContent = 'Searching eBay for: ' + q;
  }
}

/*** 9) Loop control ***/
function startLoop(){
  stopLoop();
  running = true;
  btnToggle.textContent = '⏸ Pause';
  const ms = Math.max(600, parseInt(intervalInput.value || '1500', 10));
  timer = setInterval(() => { ocrOnce(); aiOnce(); }, ms);
}
function stopLoop(){
  running = false;
  btnToggle.textContent = '▶ Resume';
  if (timer) clearInterval(timer);
  timer = null;
}

/*** 10) UI events ***/
btnToggle.addEventListener('click', () => { running ? stopLoop() : startLoop(); });
btnSearch.addEventListener('click', () => { const q = inputQuery.value || ''; if(q) maybeSearch(q); });
soldOnly.addEventListener('change', () => { if(lastQuery) maybeSearch(lastQuery); });
newly.addEventListener('change', () => { if(lastQuery) maybeSearch(lastQuery); });
intervalInput.addEventListener('change', () => { if(running) startLoop(); });

startBtn.addEventListener('click', async () => await startCamera());

// Auto-start if permission already granted
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const perm = await (navigator.permissions && navigator.permissions.query ? navigator.permissions.query({name:'camera'}) : null);
    if (perm && perm.state === 'granted') await startCamera();
  } catch {}
});
</script>
