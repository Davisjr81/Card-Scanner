<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sports Card Scanner</title>
<style>
  :root { --pad:14px; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f7f8fa;}
  .wrap{max-width:980px;margin:0 auto;padding:var(--pad);}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  video{width:100%;max-height:52vh;background:#000;border-radius:10px;object-fit:cover;border:1px solid #e5e7eb}
  button{padding:8px 12px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;font-weight:600;cursor:pointer}
  button.primary{background:#2563eb;border-color:#2563eb;color:#fff}
  button.warn{background:#f97316;border-color:#f97316;color:#fff}
  input,textarea{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px;background:#fff}
  .status{font-size:14px;color:#334155;min-height:22px;margin-top:6px}
  .item{display:flex;gap:12px;border-bottom:1px solid #e5e7eb;padding:10px 0}
  .item img{width:80px;height:80px;object-fit:cover;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">
  <h2 style="margin:6px 0">Sports Card Scanner</h2>

  <video id="v" autoplay playsinline muted></video>

  <div class="row" style="margin-top:10px">
    <button id="btnToggle">Pause</button>
    <label>Interval (ms):
      <input id="interval" type="number" min="700" step="100" value="2200" style="width:110px">
    </label>
    <button id="btnOnce">Scan Once</button>
    <button id="btnRescan" class="warn" style="margin-left:auto;display:none">Rescan</button>
  </div>

  <div id="status" class="status">Ready.</div>

  <h3>OCR Text</h3>
  <textarea id="ocr" rows="5" readonly>(no text yet)</textarea>

  <h3>Built Query</h3>
  <input id="query" placeholder="auto-built from OCR">

  <div class="row" style="margin-top:8px">
    <button id="btnSearch" class="primary">Search eBay</button>
  </div>

  <h3>eBay Results</h3>
  <div id="results"></div>
  <div id="webLink" class="status" style="margin-top:8px"></div>
</div>

<script>
/*** SET THIS TO YOUR WORKER ***/
const WORKER_URL = 'https://rough-glitter-4d48.jamie-davis81.workers.dev/';

/*** Elements ***/
const v = document.getElementById('v');
const statusEl = document.getElementById('status');
const ocrEl = document.getElementById('ocr');
const qEl = document.getElementById('query');
const btnToggle = document.getElementById('btnToggle');
const btnOnce = document.getElementById('btnOnce');
const btnRescan = document.getElementById('btnRescan');
const btnSearch = document.getElementById('btnSearch');
const intervalEl = document.getElementById('interval');
const resultsEl = document.getElementById('results');
const webLinkEl = document.getElementById('webLink');

/*** State ***/
let stream=null, timer=null, running=true, frozen=false, busy=false;

startCamera();

/*** Camera ***/
async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:{ideal:'environment'}, width:{ideal:1920}, height:{ideal:1080} },
      audio:false
    });
    v.srcObject = stream; await v.play().catch(()=>{});
    startLoop();
  }catch(e){
    status('Camera blocked. Allow access.');
    console.error(e);
  }
}
function status(s){ statusEl.textContent = s || ''; }

/*** Capture center crop (wider) and mild enhance ***/
function grabCropped(){
  if (!stream) return null;
  const W = v.videoWidth || 1280, H = v.videoHeight || 720;
  const cw = Math.floor(W*0.90), ch = Math.floor(H*0.72);     // widen crop: 90% x 72%
  const sx = Math.floor((W-cw)/2), sy = Math.floor((H-ch)/2);
  const c = document.createElement('canvas'); c.width=cw; c.height=ch;
  const ctx = c.getContext('2d');
  ctx.translate(cw,0); ctx.scale(-1,1);                       // un-mirror
  ctx.filter = 'contrast(1.24) brightness(1.06)';
  ctx.drawImage(v, sx, sy, cw, ch, 0, 0, cw, ch);
  // downscale 0.8x to reduce noise/blur
  const c2 = document.createElement('canvas');
  c2.width = Math.floor(cw*0.8); c2.height = Math.floor(ch*0.8);
  c2.getContext('2d').drawImage(c, 0, 0, c2.width, c2.height);
  return c2.toDataURL('image/jpeg', 0.92);
}

/*** Call worker: OCR.Space + eBay in one step ***/
async function analyzeAndSearch(base64){
  const r = await fetch(`${WORKER_URL}/analyze_search`, {
    method:'POST', headers:{'content-type':'application/json'},
    body: JSON.stringify({ imageBase64: base64 })
  });
  if (!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

/*** Loop control ***/
function startLoop(){
  stopLoop();
  running=true; btnToggle.textContent='Pause';
  const ms = Math.max(900, parseInt(intervalEl.value||'2200',10));
  timer = setInterval(()=>scanOnce(false), ms);
}
function stopLoop(){
  running=false; if (timer) clearInterval(timer), timer=null;
  btnToggle.textContent='Resume';
}
function freeze(){
  frozen=true; stopLoop();
  btnRescan.style.display='inline-block';
  btnToggle.disabled=true; btnOnce.disabled=true;
  status('Frozen after results — tap Rescan to continue.');
}
btnToggle.onclick = ()=> running ? stopLoop() : startLoop();
btnOnce.onclick = ()=> scanOnce(true);
btnRescan.onclick = ()=>{
  frozen=false; btnRescan.style.display='none'; btnToggle.disabled=false; btnOnce.disabled=false;
  resultsEl.innerHTML=''; webLinkEl.textContent=''; ocrEl.value='(no text yet)'; qEl.value='';
  status('Resuming…'); startLoop();
};
btnSearch.onclick = ()=>{
  const q=(qEl.value||'').trim(); if(!q) return;
  window.open(`https://www.ebay.com/sch/i.html?_nkw=${encodeURIComponent(q)}`,'_blank');
  freeze();
};

/*** One scan ***/
async function scanOnce(stopAfter=true){
  if (busy || frozen) return;
  busy=true;
  try{
    const base64 = grabCropped(); if (!base64){ busy=false; return; }
    status('Analyzing…');
    const j = await analyzeAndSearch(base64);

    const ocr = j.ocr || '';
    const query = j.query || '';
    const items = Array.isArray(j.items) ? j.items : [];
    const webUrl = j.webUrl;

    ocrEl.value = ocr || '(no text yet)';
    qEl.value = query || '';

    // Clear result area
    resultsEl.innerHTML = ''; webLinkEl.textContent = '';

    if (items.length){
      // Structured API results
      resultsEl.innerHTML = items.map(it=>{
        const title = it.title || '—';
        const price = (it.price && it.price.value && it.price.currency) ? `${it.price.value} ${it.price.currency}` : '';
        const img = it.image && it.image.imageUrl ? it.image.imageUrl : '';
        const link = it.itemWebUrl || '#';
        return `
          <div class="item">
            ${img ? `<img src="${img}" alt="">` : `<div style="width:80px;height:80px;background:#f1f5f9;border-radius:6px"></div>`}
            <div>
              <div style="font-weight:600">${title}</div>
              <div>${price}</div>
              <a href="${link}" target="_blank" rel="noopener">View on eBay</a>
            </div>
          </div>
        `;
      }).join('');
      if (stopAfter) freeze(); else status('Scanning…');
    } else if (webUrl && query){
      // Fallback: openable web search link
      webLinkEl.innerHTML = `No API results — <a href="${webUrl}" target="_blank" rel="noopener">open eBay search for “${query}”</a>`;
      if (stopAfter) freeze(); else status('Scanning…');
    } else {
      status('Low confidence — hold steady or adjust lighting.');
    }
  }catch(e){
    console.error(e);
    status('Scan error — '+e.message);
  }finally{
    busy=false;
  }
}
</script>
</body>
</html>
